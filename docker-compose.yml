version: "3.8"

services:
  db:
    image: mariadb:10.6
    container_name: magento-db
    ports:
      - "3306:3306"
    volumes:
      - magento-db-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: magento
      MYSQL_USER: magentouser
      MYSQL_PASSWORD: magentopassword
    restart: always

  opensearch:
    image: opensearchproject/opensearch:2.12.0
    container_name: magento-opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - plugins.security.disabled=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=ReallyDifferentPassword123
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    restart: always

  redis:
    image: redis:6.2-alpine
    container_name: magento-redis
    restart: always

  phpfpm:
    build:
      context: ./conf/php
      dockerfile: Dockerfile
    container_name: magento-phpfpm
    volumes:
      - ./code/:/var/www/html
      - composer-cache:/root/.composer/cache
    environment:
      DB_HOST: db
      DB_NAME: magento
      DB_USER: magentouser
      DB_PASS: magentopassword
      MAGENTO_ROOT: /var/www/html
      MAGENTO_VERSION: 2.4.7
      OPENSEARCH_HOST: opensearch
    depends_on:
      - db
      - redis
      - opensearch
    restart: always

  cron:
    build:
      context: ./conf/php
      dockerfile: Dockerfile
    container_name: magento-cron
    command: ["sh", "-c", "cron && tail -f /var/log/cron.log"]
    volumes:
      - ./code/:/var/www/html
    depends_on:
      - phpfpm
    restart: always

  web:
    image: nginx:stable-alpine
    container_name: magento-web
    ports:
      - "80:80"
    volumes:
      - ./code/:/var/www/html
      - ./conf/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - phpfpm
    restart: always

volumes:
  magento-db-data:
  composer-cache:
